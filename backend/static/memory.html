<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Management - Novel Memory</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üìö Novel Memory</div>
            <div class="nav-links">
                <a href="/" class="nav-link">Prompt Builder</a>
                <a href="/extract" class="nav-link">Extract</a>
                <a href="/memory" class="nav-link active">Memory</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="page-layout">
            <!-- Sidebar - Memory List -->
            <aside class="sidebar" id="sidebar">
                <button class="btn btn-secondary sidebar-toggle" onclick="toggleSidebar()">
                    ‚ò∞ Toggle Memory Panel
                </button>
                <div class="sidebar-title">Saved Memory</div>
                <div id="memoryPanel">
                    <div class="empty-state">Loading...</div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- Import Section -->
                <div class="card">
                    <div class="card-title">Import from Gemini</div>
                    <p class="hint">Paste the JSON response from Gemini here.</p>
                    <textarea 
                        id="jsonInput" 
                        class="json-input" 
                        placeholder='Paste JSON here...

Expected format:
{
  "Jon Snow": {"type": "character", "desc": "A brave knight..."},
  "Winterfell": {"type": "location", "desc": "An ancient castle..."}
}'
                    ></textarea>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="previewMerge()">
                            üîç Preview Merge
                        </button>
                        <button class="btn btn-secondary" onclick="clearJsonInput()">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Merge Preview Section -->
                <div class="card" id="mergePreviewCard" style="display: none;">
                    <div class="card-title">Merge Preview</div>
                    <p class="hint">Review changes before applying. Uncheck items you don't want to import/update.</p>
                    <div id="mergePreview">
                        <!-- Merge preview rendered here -->
                    </div>
                    <div class="btn-group">
                        <button class="btn btn- success" onclick="applyMerge()">
                            ‚úÖ Apply Merge
                        </button>
                        <button class="btn btn-secondary" onclick="cancelMerge()">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>

                <!-- Edit Entry Section -->
                <div class="card" id="editCard">
                    <div class="card-title" id="editCardTitle">Add New Entry</div>
                    <div class="form-group">
                        <label class="form-label">Key (Name)</label>
                        <input type="text" id="editKey" placeholder="e.g., Jon Snow">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <input type="text" id="editType" placeholder="e.g., character, location, item">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea 
                            id="editDesc" 
                            style="min-height: 100px;"
                            placeholder="Brief description of this entry..."
                        ></textarea>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveEntry()">
                            üíæ Save Entry
                        </button>
                        <button class="btn btn-danger" id="deleteEntryBtn" style="display: none;" onclick="deleteEntry()">
                            üóëÔ∏è Delete
                        </button>
                        <button class="btn btn-secondary" onclick="resetEditForm()">
                            Cancel
                        </button>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="card">
                    <div class="card-title">Actions</div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="resetEditForm()">
                            ‚ûï Add New Entry
                        </button>
                        <button class="btn btn-secondary" onclick="exportMemory()">
                            üì§ Export All JSON
                        </button>
                        <button class="btn btn-danger" onclick="confirmClearAll()">
                            üóëÔ∏è Clear All Memory
                        </button>
                    </div>
                </div>

                <!-- Export Output -->
                <div class="card" id="exportCard" style="display: none;">
                    <div class="card-title">Exported JSON</div>
                    <textarea 
                        id="exportOutput" 
                        class="json-input" 
                        readonly
                        style="min-height: 200px;"
                    ></textarea>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="copyExport()">
                            üìã Copy JSON
                        </button>
                        <button class="btn btn-secondary" onclick="closeExport()">
                            Close
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-title" id="confirmTitle">Confirm Action</div>
            <p id="confirmMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <div class="btn-group">
                <button class="btn btn-danger" id="confirmYesBtn">Yes, Delete</button>
                <button class="btn btn-secondary" onclick="closeConfirm()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // LocalStorage Functions
        // ============================================================
        const STORAGE_KEY = 'novel_memory';

        function getMemory() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.error('Error reading localStorage:', e);
                return {};
            }
        }

        function saveMemory(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                return true;
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                return false;
            }
        }

        function getMemoryGrouped() {
            const memory = getMemory();
            const grouped = {};
            
            for (const [key, value] of Object.entries(memory)) {
                const type = (value.type || 'other').toLowerCase();
                if (!grouped[type]) {
                    grouped[type] = [];
                }
                grouped[type].push({ key, ...value });
            }
            
            for (const type of Object.keys(grouped)) {
                grouped[type].sort((a, b) => a.key.localeCompare(b.key));
            }
            
            return grouped;
        }

        // ============================================================
        // State
        // ============================================================
        let currentEditKey = null;
        let mergeIncoming = null;
        let mergeAnalysis = null;
        let selectedNewKeys = [];
        let selectedUpdateKeys = [];

        // ============================================================
        // DOM Elements
        // ============================================================
        const jsonInput = document.getElementById('jsonInput');
        const mergePreviewCard = document.getElementById('mergePreviewCard');
        const mergePreviewContainer = document.getElementById('mergePreview');
        const editCardTitle = document.getElementById('editCardTitle');
        const editKey = document.getElementById('editKey');
        const editType = document.getElementById('editType');
        const editDesc = document.getElementById('editDesc');
        const deleteEntryBtn = document.getElementById('deleteEntryBtn');
        const exportCard = document.getElementById('exportCard');
        const exportOutput = document.getElementById('exportOutput');
        const memoryPanel = document.getElementById('memoryPanel');
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');

        // ============================================================
        // API Calls (Backend calculates, Frontend stores)
        // ============================================================

        async function apiMergePreview(current, incoming) {
            try {
                const res = await fetch('/api/merge/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current, incoming })
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Invalid data');
                }
                return await res.json();
            } catch (e) {
                throw e;
            }
        }

        async function apiMergeApply(current, incoming, newKeys, updateKeys) {
            try {
                const res = await fetch('/api/merge/apply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current: current,
                        incoming: incoming,
                        selected_new_keys: newKeys,
                        selected_update_keys: updateKeys
                    })
                });
                return await res.json();
            } catch (e) {
                console.error('Error applying merge:', e);
                return null;
            }
        }

        // ============================================================
        // UI Functions
        // ============================================================

        function toast(message, isError = false) {
            const existing = document.querySelectorAll('.toast');
            existing.forEach(t => t.remove());

            const div = document.createElement('div');
            div.className = `toast${isError ? ' error' : ''}`;
            div.textContent = message;
            document.body.appendChild(div);

            setTimeout(() => div.remove(), 3000);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // ============================================================
        // Render Functions
        // ============================================================

        function renderMemoryPanel() {
            const grouped = getMemoryGrouped();

            if (Object.keys(grouped).length === 0) {
                memoryPanel.innerHTML = '<div class="empty-state">No memory entries yet.<br>Import JSON or add entries manually.</div>';
                return;
            }

            let html = '';
            const sortedTypes = Object.keys(grouped).sort();

            sortedTypes.forEach(type => {
                html += `<div class="type-group">`;
                html += `<div class="type-header">${escapeHtml(type)} (${grouped[type].length})</div>`;

                grouped[type].forEach(item => {
                    const isSelected = currentEditKey === item.key;
                    html += `
                        <div class="memory-item${isSelected ? ' selected' : ''}" 
                             data-key="${escapeHtml(item.key)}"
                             title="${escapeHtml(item.desc)}">
                            ${escapeHtml(item.key)}
                        </div>
                    `;
                });

                html += `</div>`;
            });

            memoryPanel.innerHTML = html;

            // Add click handlers
            memoryPanel.querySelectorAll('.memory-item').forEach(item => {
                item.addEventListener('click', () => {
                    loadEntryForEdit(item.dataset.key);
                });
            });
        }

        function renderMergePreview() {
            if (!mergeAnalysis) return;

            let html = '';

            // Summary
            html += `<div class="merge-summary">`;
            html += `<strong>Summary:</strong> `;
            html += `<span style="color: var(--success);">+${mergeAnalysis.summary.new} new</span>, `;
            html += `<span style="color: var(--warning);">~${mergeAnalysis.summary.update} updates</span>, `;
            html += `<span style="color: var(--secondary);">${mergeAnalysis.summary.skip} unchanged</span>`;
            html += `</div>`;

            // New entries
            if (mergeAnalysis.new.length > 0) {
                html += `<div class="section-header new"><h4>‚úÖ New Entries</h4></div>`;
                mergeAnalysis.new.forEach(item => {
                    const checked = selectedNewKeys.includes(item.key) ? 'checked' : '';
                    html += `
                        <div class="merge-item new">
                            <div class="merge-item-header">
                                <label class="checkbox-container">
                                    <input type="checkbox" ${checked} data-action="new" data-key="${escapeHtml(item.key)}">
                                    <span class="merge-item-key">${escapeHtml(item.key)}</span>
                                </label>
                                <span class="merge-item-type">${escapeHtml(item.type)}</span>
                            </div>
                            <div class="merge-item-desc">${escapeHtml(item.desc)}</div>
                        </div>
                    `;
                });
            }

            // Update entries
            if (mergeAnalysis.update.length > 0) {
                html += `<div class="section-header update"><h4>‚ö†Ô∏è Updates</h4></div>`;
                mergeAnalysis.update.forEach(item => {
                    const checked = selectedUpdateKeys.includes(item.key) ? 'checked' : '';
                    html += `
                        <div class="merge-item update">
                            <div class="merge-item-header">
                                <label class="checkbox-container">
                                    <input type="checkbox" ${checked} data-action="update" data-key="${escapeHtml(item.key)}">
                                    <span class="merge-item-key">${escapeHtml(item.key)}</span>
                                </label>
                                <span class="merge-item-type">${escapeHtml(item.type)}</span>
                            </div>
                            <div class="merge-diff">
                                <div class="diff-old"><strong>Old:</strong> [${escapeHtml(item.old_type)}] ${escapeHtml(item.old_desc)}</div>
                                <div class="diff-new"><strong>New:</strong> [${escapeHtml(item.type)}] ${escapeHtml(item.desc)}</div>
                            </div>
                        </div>
                    `;
                });
            }

            // Skip entries
            if (mergeAnalysis.skip.length > 0) {
                html += `<div class="section-header skip"><h4>‚è≠Ô∏è Unchanged</h4></div>`;
                mergeAnalysis.skip.forEach(item => {
                    html += `
                        <div class="merge-item skip">
                            <div class="merge-item-header">
                                <span class="merge-item-key">${escapeHtml(item.key)}</span>
                                <span class="merge-item-type">${escapeHtml(item.type)}</span>
                            </div>
                        </div>
                    `;
                });
            }

            if (mergeAnalysis.new.length === 0 && mergeAnalysis.update.length === 0 && mergeAnalysis.skip.length === 0) {
                html = '<div class="empty-state">No entries found in the JSON.</div>';
            }

            mergePreviewContainer.innerHTML = html;

            // Add checkbox handlers
            mergePreviewContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const action = e.target.dataset.action;
                    const key = e.target.dataset.key;

                    if (action === 'new') {
                        if (e.target.checked) {
                            if (!selectedNewKeys.includes(key)) selectedNewKeys.push(key);
                        } else {
                            selectedNewKeys = selectedNewKeys.filter(k => k !== key);
                        }
                    } else if (action === 'update') {
                        if (e.target.checked) {
                            if (!selectedUpdateKeys.includes(key)) selectedUpdateKeys.push(key);
                        } else {
                            selectedUpdateKeys = selectedUpdateKeys.filter(k => k !== key);
                        }
                    }
                });
            });
        }

        // ============================================================
        // Merge Functions
        // ============================================================

        async function previewMerge() {
            const jsonStr = jsonInput.value.trim();
            if (!jsonStr) {
                toast('Please paste JSON first', true);
                return;
            }

            let parsed;
            try {
                parsed = JSON.parse(jsonStr);
            } catch (e) {
                toast('Invalid JSON: ' + e.message, true);
                return;
            }

            // Store incoming data
            mergeIncoming = parsed;

            try {
                const current = getMemory();
                mergeAnalysis = await apiMergePreview(current, parsed);
                
                // Select all by default
                selectedNewKeys = mergeAnalysis.new.map(item => item.key);
                selectedUpdateKeys = mergeAnalysis.update.map(item => item.key);

                renderMergePreview();
                mergePreviewCard.style.display = 'block';
                mergePreviewCard.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                toast(e.message, true);
            }
        }

        async function applyMerge() {
            if (!mergeIncoming || !mergeAnalysis) return;

            const current = getMemory();
            const result = await apiMergeApply(current, mergeIncoming, selectedNewKeys, selectedUpdateKeys);
            
            if (result && result.merged) {
                // Save merged data to localStorage
                saveMemory(result.merged);
                toast(`Merge complete! Added: ${result.added}, Updated: ${result.updated}, Skipped: ${result.skipped}`);
                cancelMerge();
                jsonInput.value = '';
                renderMemoryPanel();
            } else {
                toast('Error applying merge', true);
            }
        }

        function cancelMerge() {
            mergePreviewCard.style.display = 'none';
            mergeIncoming = null;
            mergeAnalysis = null;
            selectedNewKeys = [];
            selectedUpdateKeys = [];
        }

        function clearJsonInput() {
            jsonInput.value = '';
            cancelMerge();
        }

        // ============================================================
        // Edit Functions
        // ============================================================

        function loadEntryForEdit(key) {
            const memory = getMemory();
            const entry = memory[key];
            if (!entry) {
                toast('Entry not found', true);
                return;
            }

            currentEditKey = key;
            editCardTitle.textContent = 'Edit Entry';
            editKey.value = key;
            editKey.disabled = true;
            editType.value = entry.type;
            editDesc.value = entry.desc;
            deleteEntryBtn.style.display = 'inline-flex';

            renderMemoryPanel();
            document.getElementById('editCard').scrollIntoView({ behavior: 'smooth' });
        }

        function resetEditForm() {
            currentEditKey = null;
            editCardTitle.textContent = 'Add New Entry';
            editKey.value = '';
            editKey.disabled = false;
            editType.value = '';
            editDesc.value = '';
            deleteEntryBtn.style.display = 'none';
            renderMemoryPanel();
        }

        function saveEntry() {
            const key = editKey.value.trim();
            const type = editType.value.trim().toLowerCase();
            const desc = editDesc.value.trim();

            if (!key) {
                toast('Key is required', true);
                return;
            }
            if (!type) {
                toast('Type is required', true);
                return;
            }
            if (!desc) {
                toast('Description is required', true);
                return;
            }

            const memory = getMemory();
            
            // Check for duplicate when adding new
            if (!currentEditKey && memory[key]) {
                toast('An entry with this key already exists!', true);
                return;
            }

            memory[key] = { type, desc };
            saveMemory(memory);
            
            toast(currentEditKey ? 'Entry updated!' : 'Entry added!');
            resetEditForm();
            renderMemoryPanel();
        }

        function deleteEntry() {
            if (!currentEditKey) return;

            showConfirm(
                'Delete Entry',
                `Are you sure you want to delete "${currentEditKey}"?`,
                () => {
                    const memory = getMemory();
                    delete memory[currentEditKey];
                    saveMemory(memory);
                    toast('Entry deleted!');
                    resetEditForm();
                    renderMemoryPanel();
                }
            );
        }

        // ============================================================
        // Export Functions
        // ============================================================

        function exportMemory() {
            const memory = getMemory();
            const json = JSON.stringify(memory, null, 2);
            exportOutput.value = json;
            exportCard.style.display = 'block';
            exportCard.scrollIntoView({ behavior: 'smooth' });
        }

        async function copyExport() {
            const text = exportOutput.value;
            try {
                await navigator.clipboard.writeText(text);
                toast('Copied to clipboard!');
            } catch (e) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                toast('Copied to clipboard!');
            }
        }

        function closeExport() {
            exportCard.style.display = 'none';
        }

        // ============================================================
        // Confirm Modal
        // ============================================================

        let confirmCallback = null;

        function showConfirm(title, message, callback) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmCallback = callback;
            confirmModal.classList.add('active');
        }

        function closeConfirm() {
            confirmModal.classList.remove('active');
            confirmCallback = null;
        }

        confirmYesBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        });

        function confirmClearAll() {
            showConfirm(
                'Clear All Memory',
                'Are you sure you want to delete ALL memory entries? This cannot be undone!',
                () => {
                    saveMemory({});
                    toast('All memory cleared!');
                    renderMemoryPanel();
                    resetEditForm();
                }
            );
        }

        // ============================================================
        // Initialize
        // ============================================================

        function init() {
            renderMemoryPanel();
        }

        init();
    </script>
</body>
</html>