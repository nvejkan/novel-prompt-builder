<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extract Data - Novel Memory</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">ðŸ“š Novel Memory</div>
            <div class="nav-links">
                <a href="/" class="nav-link">Prompt Builder</a>
                <a href="/extract" class="nav-link active">Extract</a>
                <a href="/memory" class="nav-link">Memory</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <main class="main-content" style="max-width: 900px; margin: 0 auto;">
            <!-- Story Input -->
            <div class="card">
                <div class="card-title">Paste Gemini's Story Output</div>
                <textarea 
                    id="storyInput" 
                    class="story-input" 
                    style="min-height: 200px;"
                    placeholder="Paste the story generated by Gemini here...

Example: The dragon soared over Winterfell as Jon Snow drew his sword Longclaw. Beside him, Arya watched with keen eyes..."
                ></textarea>
            </div>

            <!-- Extraction Types -->
            <div class="card">
                <div class="card-title">What to Extract</div>
                <p class="hint">Click Ã— to remove types. Add custom types below.</p>
                <div class="type-tags-input" id="typeTags">
                    <!-- Type tags rendered here -->
                </div>
                <div class="type-input-wrapper">
                    <input 
                        type="text" 
                        id="customTypeInput" 
                        placeholder="Add custom type (e.g., weapon, spell)"
                    >
                    <button class="btn btn-secondary" onclick="addCustomType()">+ Add</button>
                </div>
            </div>

            <!-- Generated Extraction Prompt -->
            <div class="card">
                <div class="card-title">Generated Extraction Prompt</div>
                <textarea 
                    id="promptOutput" 
                    class="prompt-output" 
                    readonly
                    placeholder="The extraction prompt will appear here..."
                ></textarea>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="copyPrompt()">
                        ðŸ“‹ Copy Prompt
                    </button>
                    <button class="btn btn-secondary" onclick="resetTypes()">
                        ðŸ”„ Reset Types
                    </button>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <div class="card-title">How to Use</div>
                <ol style="margin-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 2;">
                    <li>Paste the story from Gemini into the text box above</li>
                    <li>Adjust the types you want to extract</li>
                    <li>Copy the generated extraction prompt</li>
                    <li>Paste the prompt into Gemini</li>
                    <li>Copy Gemini's JSON response</li>
                    <li>Go to <a href="/memory" style="color: var(--primary);">Memory</a> page and import the JSON</li>
                </ol>
            </div>
        </main>
    </div>

    <script>
        // ============================================================
        // LocalStorage Functions
        // ============================================================
        const STORAGE_KEY = 'novel_memory';

        function getMemory() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                return {};
            }
        }

        function getMemoryTypes() {
            const memory = getMemory();
            const types = new Set();
            for (const entry of Object.values(memory)) {
                if (entry.type) {
                    types.add(entry.type.toLowerCase());
                }
            }
            return Array.from(types).sort();
        }

        // ============================================================
        // State
        // ============================================================
        const DEFAULT_TYPES = ['character', 'location', 'item', 'event'];
        let extractTypes = [];

        // ============================================================
        // DOM Elements
        // ============================================================
        const storyInput = document.getElementById('storyInput');
        const promptOutput = document.getElementById('promptOutput');
        const typeTagsContainer = document.getElementById('typeTags');
        const customTypeInput = document.getElementById('customTypeInput');

        // ============================================================
        // API Calls
        // ============================================================

        async function apiBuildExtractPrompt(story, types) {
            try {
                const res = await fetch('/api/prompt/extract', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ story, types })
                });
                return await res.json();
            } catch (e) {
                console.error('Error building prompt:', e);
                return { prompt: '' };
            }
        }

        // ============================================================
        // UI Functions
        // ============================================================

        function toast(message, isError = false) {
            const existing = document.querySelectorAll('.toast');
            existing.forEach(t => t.remove());

            const div = document.createElement('div');
            div.className = `toast${isError ? ' error' : ''}`;
            div.textContent = message;
            document.body.appendChild(div);

            setTimeout(() => div.remove(), 3000);
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ============================================================
        // Render Functions
        // ============================================================

        function renderTypeTags() {
            if (extractTypes.length === 0) {
                typeTagsContainer.innerHTML = '<span style="color: var(--text-secondary);">No types selected</span>';
                return;
            }

            let html = '';
            extractTypes.forEach(type => {
                html += `
                    <span class="tag" data-type="${escapeHtml(type)}">
                        ${escapeHtml(type)}
                        <span class="tag-remove" data-type="${escapeHtml(type)}">Ã—</span>
                    </span>
                `;
            });

            typeTagsContainer.innerHTML = html;

            // Add remove handlers
            typeTagsContainer.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeType(btn.dataset.type);
                });
            });
        }

        // ============================================================
        // Type Management
        // ============================================================

        function removeType(type) {
            extractTypes = extractTypes.filter(t => t !== type);
            renderTypeTags();
            updatePrompt();
        }

        function addCustomType() {
            const type = customTypeInput.value.trim().toLowerCase();
            if (!type) return;

            if (extractTypes.includes(type)) {
                toast('Type already exists!', true);
                return;
            }

            extractTypes.push(type);
            extractTypes.sort();
            customTypeInput.value = '';
            renderTypeTags();
            updatePrompt();
            toast(`Added type: ${type}`);
        }

        function resetTypes() {
            const memoryTypes = getMemoryTypes();
            const allTypes = new Set([...DEFAULT_TYPES, ...memoryTypes]);
            extractTypes = Array.from(allTypes).sort();
            renderTypeTags();
            updatePrompt();
            toast('Types reset');
        }

        // ============================================================
        // Main Logic
        // ============================================================

        async function updatePrompt() {
            const story = storyInput.value.trim();

            if (!story) {
                promptOutput.value = '';
                return;
            }

            if (extractTypes.length === 0) {
                promptOutput.value = 'Please select at least one type to extract.';
                return;
            }

            const result = await apiBuildExtractPrompt(story, extractTypes);
            promptOutput.value = result.prompt;
        }

        async function copyPrompt() {
            const text = promptOutput.value;
            if (!text) {
                toast('Nothing to copy!', true);
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                toast('Copied to clipboard!');
            } catch (e) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                toast('Copied to clipboard!');
            }
        }

        // ============================================================
        // Initialize
        // ============================================================

        function init() {
            resetTypes();

            // Event listeners
            storyInput.addEventListener('input', updatePrompt);
            customTypeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addCustomType();
            });
        }

        init();
    </script>
</body>
</html>